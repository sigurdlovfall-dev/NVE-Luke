<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Glideluke â€“ BeregningsverktÃ¸y (NVE Retningslinjer 1/2011)</title>
<style>
  :root {
    --blue-dark:  #1a3a5c;
    --blue-mid:   #2563a8;
    --blue-light: #dbeafe;
    --accent:     #e07b00;
    --green:      #15803d;
    --red:        #dc2626;
    --warn-bg:    #fef3c7;
    --warn-border:#d97706;
    --err-bg:     #fee2e2;
    --err-border: #dc2626;
    --ok-bg:      #dcfce7;
    --ok-border:  #15803d;
    --gray-light: #f8fafc;
    --gray-mid:   #e2e8f0;
    --gray-dark:  #475569;
    --shadow:     0 2px 8px rgba(0,0,0,0.12);
    --radius:     6px;
    --font:       'Segoe UI', system-ui, sans-serif;
    --mono:       'Consolas', 'Courier New', monospace;
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: var(--font);
    font-size: 14px;
    background: #f0f4f8;
    color: #1e293b;
    line-height: 1.5;
  }

  /* â”€â”€ HEADER â”€â”€ */
  header {
    background: var(--blue-dark);
    color: #fff;
    padding: 16px 24px;
    display: flex;
    align-items: center;
    gap: 16px;
    box-shadow: var(--shadow);
  }
  header .logo { font-size: 28px; }
  header h1 { font-size: 18px; font-weight: 700; line-height: 1.2; }
  header p  { font-size: 11px; opacity: .75; margin-top: 2px; }
  .nve-badge {
    margin-left: auto;
    background: rgba(255,255,255,.15);
    border: 1px solid rgba(255,255,255,.3);
    border-radius: 4px;
    padding: 4px 10px;
    font-size: 11px;
    white-space: nowrap;
  }

  /* â”€â”€ LAYOUT â”€â”€ */
  .app {
    display: grid;
    grid-template-columns: 380px 1fr;
    gap: 16px;
    padding: 16px;
    max-width: 1400px;
    margin: 0 auto;
  }
  @media (max-width: 900px) {
    .app { grid-template-columns: 1fr; }
  }

  /* â”€â”€ PANELS â”€â”€ */
  .panel {
    background: #fff;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
  }
  .panel-header {
    background: var(--blue-dark);
    color: #fff;
    padding: 10px 16px;
    font-size: 13px;
    font-weight: 700;
    letter-spacing: .3px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .panel-header .icon { font-size: 16px; }
  .panel-body { padding: 14px 16px; }

  /* â”€â”€ INPUT SECTIONS â”€â”€ */
  .section-title {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: .6px;
    color: var(--blue-mid);
    border-bottom: 2px solid var(--blue-light);
    padding-bottom: 4px;
    margin: 14px 0 10px;
  }
  .section-title:first-child { margin-top: 0; }

  .field { margin-bottom: 10px; }
  .field label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 3px;
    color: #334155;
  }
  .field label .sym {
    font-family: var(--mono);
    color: var(--blue-mid);
    font-style: italic;
  }
  .field-row {
    display: flex;
    gap: 6px;
    align-items: center;
  }
  .field-row input, .field-row select {
    flex: 1;
  }
  input[type=number], input[type=text], select {
    width: 100%;
    padding: 6px 10px;
    border: 1.5px solid var(--gray-mid);
    border-radius: 4px;
    font-family: var(--mono);
    font-size: 13px;
    color: #1e293b;
    transition: border-color .15s;
    background: #fff;
  }
  input[type=number]:focus, input[type=text]:focus, select:focus {
    outline: none;
    border-color: var(--blue-mid);
  }
  input.invalid { border-color: var(--red); background: #fff5f5; }
  .unit {
    font-size: 11px;
    color: var(--gray-dark);
    white-space: nowrap;
    min-width: 36px;
    font-family: var(--mono);
  }
  .hint {
    font-size: 10.5px;
    color: #94a3b8;
    margin-top: 2px;
  }

  /* â”€â”€ MESSAGES â”€â”€ */
  .msg-area { margin-top: 12px; }
  .msg {
    display: flex;
    gap: 8px;
    align-items: flex-start;
    padding: 8px 10px;
    border-radius: 4px;
    font-size: 12px;
    margin-bottom: 6px;
    border-left: 3px solid;
  }
  .msg-err  { background: var(--err-bg);  border-color: var(--err-border);  }
  .msg-warn { background: var(--warn-bg); border-color: var(--warn-border); }
  .msg-ok   { background: var(--ok-bg);   border-color: var(--ok-border);   }
  .msg .icon { font-size: 14px; flex-shrink: 0; margin-top: 1px; }

  /* â”€â”€ TABS â”€â”€ */
  .tabs { display: flex; border-bottom: 2px solid var(--gray-mid); }
  .tab-btn {
    padding: 9px 16px;
    font-size: 12px;
    font-weight: 600;
    color: var(--gray-dark);
    cursor: pointer;
    border: none;
    background: none;
    border-bottom: 3px solid transparent;
    margin-bottom: -2px;
    transition: color .15s, border-color .15s;
  }
  .tab-btn:hover { color: var(--blue-mid); }
  .tab-btn.active {
    color: var(--blue-dark);
    border-bottom-color: var(--blue-mid);
  }
  .tab-content { display: none; padding: 14px; }
  .tab-content.active { display: block; }

  /* â”€â”€ RESULT CARDS â”€â”€ */
  .result-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 10px;
    margin-bottom: 14px;
  }
  .result-card {
    background: var(--gray-light);
    border: 1.5px solid var(--gray-mid);
    border-radius: 5px;
    padding: 10px 12px;
  }
  .result-card .label {
    font-size: 10.5px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: .4px;
    color: var(--gray-dark);
    margin-bottom: 4px;
  }
  .result-card .value {
    font-family: var(--mono);
    font-size: 18px;
    font-weight: 700;
    color: var(--blue-dark);
  }
  .result-card .sub {
    font-size: 10px;
    color: #94a3b8;
    margin-top: 2px;
  }
  .result-card.highlight {
    background: var(--blue-light);
    border-color: var(--blue-mid);
  }
  .result-card.highlight .value { color: var(--blue-mid); }
  .result-card.warning-card {
    background: var(--warn-bg);
    border-color: var(--warn-border);
  }
  .result-card.warning-card .value { color: var(--accent); }

  /* â”€â”€ FORMULA TRACE â”€â”€ */
  .trace-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
    margin-bottom: 10px;
  }
  .trace-table th {
    background: var(--blue-light);
    color: var(--blue-dark);
    padding: 6px 10px;
    text-align: left;
    font-weight: 700;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: .4px;
  }
  .trace-table td {
    padding: 6px 10px;
    border-bottom: 1px solid var(--gray-mid);
    vertical-align: top;
  }
  .trace-table tr:last-child td { border-bottom: none; }
  .trace-table .formula {
    font-family: var(--mono);
    font-size: 11.5px;
    color: var(--blue-mid);
  }
  .trace-table .ref {
    font-size: 10.5px;
    color: #94a3b8;
  }
  .trace-table .num {
    font-family: var(--mono);
    font-weight: 700;
    color: var(--blue-dark);
  }
  .trace-table tr:hover td { background: #f8fafc; }

  /* â”€â”€ SVG FIGURES â”€â”€ */
  .figure-wrap {
    background: var(--gray-light);
    border: 1px solid var(--gray-mid);
    border-radius: 5px;
    padding: 12px;
    text-align: center;
    margin-bottom: 14px;
  }
  .figure-wrap figcaption {
    font-size: 11px;
    color: var(--gray-dark);
    margin-top: 6px;
    font-style: italic;
  }
  svg { max-width: 100%; height: auto; }

  /* â”€â”€ MISC â”€â”€ */
  .ref-badge {
    display: inline-block;
    background: var(--blue-light);
    color: var(--blue-dark);
    font-size: 10px;
    font-weight: 700;
    padding: 1px 6px;
    border-radius: 10px;
    margin-left: 4px;
    font-family: var(--mono);
  }
  .separator {
    height: 1px;
    background: var(--gray-mid);
    margin: 12px 0;
  }
  .small-note {
    font-size: 10.5px;
    color: #94a3b8;
    font-style: italic;
    margin-bottom: 6px;
  }
  .status-bar {
    background: var(--blue-dark);
    color: rgba(255,255,255,.8);
    font-size: 11px;
    padding: 5px 24px;
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
  }
  .status-bar span { display: flex; align-items: center; gap: 4px; }
  .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
  .dot-green { background: #4ade80; }
  .dot-red   { background: #f87171; }
  .dot-yellow{ background: #fbbf24; }
</style>
</head>
<body>

<header>
  <div class="logo">ğŸ”©</div>
  <div>
    <h1>Glideluke â€“ BeregningsverktÃ¸y for tappe- og stengeorgan</h1>
    <p>Hydrostatisk kraftberegning Â· Dimensjonerende laster Â· ManÃ¸vreringskrefter</p>
  </div>
  <div class="nve-badge">NVE Retningslinjer 1/2011</div>
</header>

<div id="statusBar" class="status-bar">
  <span><span class="dot dot-yellow" id="dot-input"></span> Inndata ikke validert</span>
  <span id="sb-h">h = â€“ m</span>
  <span id="sb-F">F<sub>res</sub> = â€“ kN</span>
  <span id="sb-M">Angrepspunkt = â€“ m</span>
</div>

<div class="app">
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LEFT COLUMN â€“ INPUT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div>
    <div class="panel">
      <div class="panel-header"><span class="icon">âš™ï¸</span> Inndata</div>
      <div class="panel-body">

        <div class="section-title">Lukegeometri</div>

        <div class="field">
          <label>Lukebredde <span class="sym">B</span></label>
          <div class="field-row">
            <input type="number" id="B" value="1.5" min="0.05" max="30" step="0.01">
            <span class="unit">m</span>
          </div>
          <div class="hint">Fri Ã¥pningsbredde (mellom glidelister/sider)</div>
        </div>

        <div class="field">
          <label>LukehÃ¸yde <span class="sym">H_L</span></label>
          <div class="field-row">
            <input type="number" id="H_L" value="1.2" min="0.05" max="30" step="0.01">
            <span class="unit">m</span>
          </div>
          <div class="hint">HÃ¸yde pÃ¥ lukeblad (tettet Ã¥pning)</div>
        </div>

        <div class="field">
          <label>Underkant luke (over bunnen) <span class="sym">z_UK</span></label>
          <div class="field-row">
            <input type="number" id="z_UK" value="0" min="0" max="200" step="0.01">
            <span class="unit">m</span>
          </div>
          <div class="hint">Koteavstand fra bunnen til underkant luke (0 = bunntappeluke)</div>
        </div>

        <div class="separator"></div>
        <div class="section-title">Vannstander</div>

        <div class="field">
          <label>OppstrÃ¸ms vannstand <span class="sym">HRV / hâ‚</span></label>
          <div class="field-row">
            <input type="number" id="h1" value="5.0" min="0" max="300" step="0.01">
            <span class="unit">m</span>
          </div>
          <div class="hint">Vannstand over ukens underkant, oppstrÃ¸ms (â‰¥ lukehÃ¸yde for fullt trykk)</div>
        </div>

        <div class="field">
          <label>NedstrÃ¸ms vannstand <span class="sym">hâ‚‚</span></label>
          <div class="field-row">
            <input type="number" id="h2" value="0.0" min="0" max="300" step="0.01">
            <span class="unit">m</span>
          </div>
          <div class="hint">Vannstand over underkant luke, nedstrÃ¸ms (0 = tÃ¸rt nedstrÃ¸ms)</div>
        </div>

        <div class="separator"></div>
        <div class="section-title">Driftstilstand og klasse</div>

        <div class="field">
          <label>Lukeposisjon / driftstilstand</label>
          <select id="driftstilstand">
            <option value="stengt">Stengt â€“ fullt hydrostatisk trykk</option>
            <option value="apning">Ã…pning â€“ trykk-belastet manÃ¸vrering</option>
            <option value="mellom">Mellomstilling â€“ regulering</option>
          </select>
        </div>

        <div class="field">
          <label>Konsekvensklasse</label>
          <select id="konsekvensklasse">
            <option value="1">Klasse 1</option>
            <option value="2" selected>Klasse 2</option>
            <option value="3">Klasse 3</option>
          </select>
          <div class="hint">Jf. damsikkerhetsforskriften Â§ 4-1</div>
        </div>

        <div class="field">
          <label>Funksjon</label>
          <select id="funksjon">
            <option value="tappe" selected>Tappeluke / stengeorgan</option>
            <option value="flom">Flomluke</option>
            <option value="inntak">Inntaksluke</option>
          </select>
        </div>

        <div class="separator"></div>
        <div class="section-title">Material og friksjon</div>

        <div class="field">
          <label>StÃ¥lkvalitet (flytegrense) <span class="sym">R_e</span></label>
          <div class="field-row">
            <input type="number" id="Re" value="355" min="100" max="700" step="5">
            <span class="unit">MPa</span>
          </div>
          <div class="hint">S235=235, S275=275, S355=355 MPa</div>
        </div>

        <div class="field">
          <label>Glidelisttype</label>
          <select id="glideliste">
            <option value="bronse">Bronse mot rustfritt stÃ¥l â€“ Î¼ = 0,60</option>
            <option value="polymer" selected>Polymer/polyamid mot rustfritt stÃ¥l â€“ Î¼ = 0,40</option>
            <option value="spesial">Spesialglidelager (beskyttet) â€“ Î¼ = 0,15</option>
          </select>
          <div class="hint">Jf. NVE Tabell 5.1 (minimumsverdier)</div>
        </div>

        <div class="field">
          <label>Egenvekt lukekonstruksjon <span class="sym">G</span></label>
          <div class="field-row">
            <input type="number" id="G" value="5.0" min="0" max="5000" step="0.5">
            <span class="unit">kN</span>
          </div>
        </div>

        <div class="separator"></div>
        <div class="section-title">Grensetilstand</div>

        <div class="field">
          <label>Beregningstype</label>
          <select id="grensetilstand">
            <option value="brudd">Bruddgrensetilstand (ULS)</option>
            <option value="ulykke">Ulykkesgrensetilstand (ALS)</option>
            <option value="bruks">Bruksgrensetilstand (SLS)</option>
          </select>
        </div>

      </div><!-- /panel-body -->
    </div><!-- /panel -->

    <!-- Validation messages -->
    <div id="msgArea" class="msg-area" style="margin-top:10px;"></div>

  </div><!-- /left column -->

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RIGHT COLUMN â€“ RESULTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div>
    <div class="panel">
      <div class="tabs">
        <button class="tab-btn active" onclick="showTab('results')">ğŸ“Š Resultater</button>
        <button class="tab-btn" onclick="showTab('trace')">ğŸ§® Beregningsspor</button>
        <button class="tab-btn" onclick="showTab('figure')">ğŸ“ Figur</button>
        <button class="tab-btn" onclick="showTab('check')">âœ… Kontroll</button>
        <button class="tab-btn" onclick="showTab('rapport')" style="margin-left:auto;color:#1a3a5c;font-weight:800;">ğŸ“„ Rapport</button>
      </div>

      <!-- TAB: RESULTS -->
      <div id="tab-results" class="tab-content active">

        <div id="hydro-cards" class="result-grid"></div>

        <div class="section-title">Dimensjonerende laster (med lastfaktorer)</div>
        <div id="dim-cards" class="result-grid"></div>

        <div class="section-title">ManÃ¸vreringskrefter</div>
        <div id="mano-cards" class="result-grid"></div>

      </div>

      <!-- TAB: TRACE -->
      <div id="tab-trace" class="tab-content">
        <div class="small-note">Alle beregningstrinn med formler og referanser til NVE-veilederen.</div>
        <div id="traceContent"></div>
      </div>

      <!-- TAB: FIGURE -->
      <div id="tab-figure" class="tab-content">
        <div class="figure-wrap">
          <canvas id="lukeCanvas" width="900" height="620" style="width:100%;height:auto;"></canvas>
          <figcaption id="figCaption">Schematisk fremstilling av glideluke med trykkfordeling</figcaption>
        </div>
      </div>

      <!-- TAB: CHECK -->
      <div id="tab-check" class="tab-content">
        <div class="section-title">GyldighetsomrÃ¥de og forutsetninger</div>
        <div id="checkContent"></div>

        <div class="section-title" style="margin-top:16px;">Kapasitetskontroll â€“ stÃ¥l</div>
        <div id="capacityContent"></div>

        <div class="section-title" style="margin-top:16px;">Advarsler og spesielle hensyn</div>
        <div id="warningsContent"></div>
      </div>

      <!-- TAB: RAPPORT -->
      <div id="tab-rapport" class="tab-content">
        <div style="display:flex;gap:10px;align-items:center;margin-bottom:14px;flex-wrap:wrap;">
          <div>
            <div style="font-size:12px;font-weight:700;color:#334155;margin-bottom:4px;">Prosjektnavn</div>
            <input type="text" id="rpt-prosjekt" placeholder="F.eks. Reguleringsdam Glomma" style="width:260px;">
          </div>
          <div>
            <div style="font-size:12px;font-weight:700;color:#334155;margin-bottom:4px;">Utarbeidet av</div>
            <input type="text" id="rpt-autor" placeholder="Navn / firma">
          </div>
          <div>
            <div style="font-size:12px;font-weight:700;color:#334155;margin-bottom:4px;">Dok.nr.</div>
            <input type="text" id="rpt-dokref" placeholder="F.eks. STA-2025-001" style="width:140px;">
          </div>
          <div style="margin-left:auto;display:flex;gap:8px;">
            <button onclick="exportWord()" style="background:#1a3a5c;color:white;border:none;border-radius:5px;padding:9px 18px;font-size:13px;font-weight:700;cursor:pointer;">â¬‡ Word (.doc)</button>
            <button onclick="exportPDF()"  style="background:#dc2626;color:white;border:none;border-radius:5px;padding:9px 18px;font-size:13px;font-weight:700;cursor:pointer;">â¬‡ PDF</button>
            <button onclick="previewReport()" style="background:#e2e8f0;color:#334155;border:none;border-radius:5px;padding:9px 14px;font-size:13px;cursor:pointer;">ğŸ‘ ForhÃ¥ndsvis</button>
          </div>
        </div>
        <div id="reportPreview" style="border:1px solid #e2e8f0;border-radius:5px;background:#f8fafc;padding:16px;min-height:200px;">
          <p style="color:#94a3b8;font-size:12px;text-align:center;margin-top:40px;">Klikk Â«ForhÃ¥ndsvisÂ» for Ã¥ se rapporten, eller Â«Last ned WordÂ» for Ã¥ eksportere direkte.</p>
        </div>
      </div>

    </div><!-- /panel -->
  </div><!-- /right column -->
</div><!-- /app -->

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSTANTS â€“ direct from NVE Retningslinjer 1/2011
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const RHO_W  = 1000;    // kg/mÂ³ water density
const G_GRAV = 9.81;    // m/sÂ²
const GAMMA_W = RHO_W * G_GRAV / 1000;  // 9.81 kN/mÂ³

// Load factors â€“ Table 2.1 (NVE 1/2011)
const LF = {
  brudd: {
    statisk:   1.2,   // permanent static water pressure (standard)
    tappeluke: 1.4,   // tappe-/flomorganer (Â§ 2.5 special rule)
    variable:  1.2,
    ulykke:    1.0,
  },
  ulykke: { statisk: 1.0, tappeluke: 1.0, variable: 1.0 },
  bruks:  { statisk: 1.0, tappeluke: 1.0, variable: 1.0 },
};

// Material factors â€“ Table 4.1 (NVE 1/2011)
const MF = {
  brudd:  { med: 1.25, uten: 1.60 },
  ulykke: { med: 1.10, uten: 1.30 },
  bruks:  { med: 1.00, uten: 1.00 },
};

// Friction coefficients â€“ Table 5.1 (NVE 1/2011)
const MU = {
  bronse:  0.60,
  polymer: 0.40,
  spesial: 0.15,
};

// Capacity factors for manoeuvring â€“ NVE Â§ 5.2
const PSI = {
  tappe: 1.0,   // Glideluke mot fullt trykk, glidelistfriksjon 0,6
  flom:  1.2,   // Glideluke trykkavlastet / rulleluke
  inntak: 1.2,
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let state = {};
let errors = [];
let warnings = [];
let results = {};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INPUT HANDLING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const inputIds = ['B','H_L','z_UK','h1','h2','Re','G','driftstilstand',
                  'konsekvensklasse','funksjon','glideliste','grensetilstand'];

inputIds.forEach(id => {
  const el = document.getElementById(id);
  if (el) el.addEventListener('input', onInputChange);
});

function onInputChange() {
  validate();
  if (errors.length === 0) calculate();
  render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VALIDATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function validate() {
  errors = [];
  warnings = [];

  const get = id => {
    const el = document.getElementById(id);
    el && el.classList.remove('invalid');
    return parseFloat(el ? el.value : NaN);
  };
  const fail = (id, msg) => {
    errors.push({ id, msg });
    const el = document.getElementById(id);
    if (el && el.type === 'number') el.classList.add('invalid');
  };
  const warn = msg => warnings.push(msg);

  const B   = get('B');
  const H_L = get('H_L');
  const z_UK= get('z_UK');
  const h1  = get('h1');
  const h2  = get('h2');
  const Re  = get('Re');
  const G   = get('G');

  // Geometry checks
  if (isNaN(B) || B <= 0)    fail('B',   'Lukebredde B mÃ¥ vÃ¦re positiv (> 0 m).');
  if (isNaN(H_L) || H_L <= 0) fail('H_L','LukehÃ¸yde H_L mÃ¥ vÃ¦re positiv (> 0 m).');
  if (isNaN(z_UK) || z_UK < 0) fail('z_UK','Underkant luke z_UK kan ikke vÃ¦re negativ.');
  if (isNaN(h1) || h1 < 0)   fail('h1',  'OppstrÃ¸ms vannstand hâ‚ kan ikke vÃ¦re negativ.');
  if (isNaN(h2) || h2 < 0)   fail('h2',  'NedstrÃ¸ms vannstand hâ‚‚ kan ikke vÃ¦re negativ.');
  if (!isNaN(h2) && !isNaN(h1) && h2 > h1)
    fail('h2', 'NedstrÃ¸ms vannstand hâ‚‚ kan ikke overstige oppstrÃ¸ms hâ‚ (fysisk umulig).');
  if (isNaN(Re) || Re < 100)  fail('Re',  'Flytegrense Re mÃ¥ vÃ¦re â‰¥ 100 MPa.');
  if (Re > 700)               warn('Flytegrense Re > 700 MPa â€“ kontroller materialvalg.');
  if (isNaN(G) || G < 0)     fail('G',   'Egenvekt G kan ikke vÃ¦re negativ.');

  // Water level vs geometry
  if (!isNaN(h1) && !isNaN(H_L) && h1 < H_L)
    warn('OppstrÃ¸ms vannstand hâ‚ < lukehÃ¸yde H_L: luken er delvis eksponert â€“ halvt trykk beregnes.');

  // Minimum pressure difference check (NVE Â§ 2.2)
  if (!isNaN(h1) && !isNaN(h2)) {
    const dh = h1 - h2;
    const min_dh = Math.max(0.1 * h1, 10); // 10 % of max pressure or min 10 m
    // Only warn if both sides have pressure
    if (h2 > 0 && dh > 0 && dh < 10)
      warn(`Trykkdifferanse Î”h = ${dh.toFixed(2)} m < 10 m minstekrav (NVE Â§ 2.2). Sett Î”h â‰¥ maks(10 % av hâ‚, 10 m) = ${min_dh.toFixed(1)} m ved innbyrdes koblet trykk.`);
  }

  // High-pressure warnings (NVE C.4)
  if (!isNaN(h1)) {
    if (h1 > 40) warn('TrykkhÃ¸yde > 40 m: spesiell utforming av lukeblad, foringsnisjer og platekasse nÃ¸dvendig (NVE C.4). Kavitasjon og vibrasjon mÃ¥ utredes.');
    else if (h1 > 20) warn('TrykkhÃ¸yde > 20 m: lufting nedstrÃ¸ms tappeluke mÃ¥ vurderes nÃ¸ye (NVE C.1). Vurder spesialkompetanse for hydrauliske effekter.');
  }

  // Width vs height check (NVE C.4)
  if (!isNaN(B) && !isNaN(H_L) && B > H_L)
    warn('Lukebredde B > lukehÃ¸yde H_L: styreruller eller styreskinner bÃ¸r vurderes (NVE C.4).');

  // Store for use in calculation
  state = {
    B, H_L, z_UK, h1, h2, Re, G,
    driftstilstand: document.getElementById('driftstilstand').value,
    konsekvensklasse: parseInt(document.getElementById('konsekvensklasse').value),
    funksjon: document.getElementById('funksjon').value,
    glideliste: document.getElementById('glideliste').value,
    grensetilstand: document.getElementById('grensetilstand').value,
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CALCULATION ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calculate() {
  const { B, H_L, z_UK, h1, h2, Re, G,
          funksjon, glideliste, grensetilstand, driftstilstand } = state;

  const mu    = MU[glideliste];
  const area  = B * H_L;   // mÂ²

  // â”€â”€ Effective water depth above gate bottom (top of gate)
  const h_top = h1 - H_L;   // may be < 0 if h1 < H_L

  // â”€â”€ Upstream pressure distribution â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Pressure at bottom of gate (kPa = kN/mÂ²)
  const p_UK1  = Math.max(0, h1)      * GAMMA_W;   // at underkant
  const p_OK1  = Math.max(0, h_top)   * GAMMA_W;   // at overkant  (0 if partially submerged)

  // â”€â”€ Downstream pressure distribution â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const p_UK2  = Math.max(0, h2)      * GAMMA_W;
  const h2_top = h2 - H_L;
  const p_OK2  = Math.max(0, h2_top)  * GAMMA_W;

  // â”€â”€ Net pressure at UK and OK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const p_net_UK = p_UK1 - p_UK2;   // kN/mÂ²
  const p_net_OK = p_OK1 - p_OK2;

  // â”€â”€ Resultant hydrostatic force (trapezoidal distribution) â”€â”€â”€â”€
  // F = [(p_UK + p_OK)/2] * B * H_L  (kN)
  const F_hyd = ((p_net_UK + p_net_OK) / 2) * B * H_L;

  // â”€â”€ Point of application (from bottom of gate) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // For a trapezoid (p_OK at top, p_UK at bottom):
  // e = H_L/3 * (2*p_UK + p_OK) / (p_UK + p_OK)   from bottom
  let e_kp;
  if (Math.abs(p_net_UK + p_net_OK) < 1e-9) {
    e_kp = H_L / 2;
  } else {
    // Centroid of trapezoid from bottom: e = H * (2Â·p_top + p_bot) / (3Â·(p_bot + p_top))
    e_kp = H_L * (2 * p_net_OK + p_net_UK) / (3 * (p_net_UK + p_net_OK));
  }

  // Also express as height above gate bottom in absolute terms
  const e_abs = z_UK + e_kp;  // m above bottom datum

  // â”€â”€ Moment about gate bottom â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const M_hyd = F_hyd * e_kp;  // kNÂ·m

  // â”€â”€ Load factors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let gamma_f;
  if (grensetilstand === 'brudd') {
    // Special rule: tappe-/flomorganer get f=1.4 (NVE Â§ 2.5)
    gamma_f = (funksjon === 'tappe' || funksjon === 'flom') ? LF.brudd.tappeluke : LF.brudd.statisk;
  } else if (grensetilstand === 'ulykke') {
    gamma_f = 1.0;
  } else {
    gamma_f = 1.0;
  }

  const F_dim   = gamma_f * F_hyd;
  const M_dim   = gamma_f * M_hyd;

  // â”€â”€ Net area pressure (average) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const p_avg = F_hyd > 0 ? F_hyd / area : 0;

  // â”€â”€ Manoeuvring forces â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Friction force (both sides of gate, assumed symmetric):
  const F_frict = mu * F_hyd;   // kN  (sliding resistance)

  // Operating force to lift gate (against full water pressure):
  //   F_op = G + F_frict  (pulling gate up)
  //   Capacity factor Ïˆ from NVE Â§ 5.2 (applied to required capacity)
  const psi     = funksjon === 'tappe' ? PSI.tappe : PSI.flom;
  const F_lift  = G + F_frict;      // kN to lift
  const F_lower = G - F_frict;      // kN to lower (may be negative = self-weight closes)

  // Required capacity of actuator with spillage factor:
  const F_actuator = F_lift * psi;

  // Self-closing check (NVE Â§ 5.2): resultant downward force > 25% of opposing forces
  // Closing force = gravity component - friction when closing
  const F_close_net = G - F_frict;   // net downward force
  const selfClosing  = F_close_net > 0 && F_close_net > 0.25 * F_frict;

  // â”€â”€ Material capacity check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Characteristic yield strength (NVE Â§ 4.2): limit to 80% of Rm (approx), use Re directly
  // Design yield strength = Re / gamma_m
  const gamma_m = MF[grensetilstand]?.med ?? 1.25;
  const f_yd    = (Re * 0.8) / gamma_m;   // MPa (80% of Re as per NVE Â§ 4.2)

  // Approximate hoop/bending stress on face plate (simplified, indicative only)
  // For a plate span B, uniform pressure p_avg, simply supported: sigma = p_avg*BÂ²/(8*t_estÂ²) (MPa)
  // We cannot compute without plate thickness â€“ provide p_avg for user's cross-section check

  // â”€â”€ Minimum sealing pressure check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // NVE Â§ 5.2: flat rubber seal â†’ min 5 kN/m sealing length
  const tettelengde = 2 * (B + H_L);   // perimeter (m)
  const F_seal_req  = 5 * tettelengde;  // kN

  // â”€â”€ Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  results = {
    // Geometry
    area, h_top,
    // Pressures
    p_UK1, p_OK1, p_UK2, p_OK2, p_net_UK, p_net_OK, p_avg,
    // Hydrostatic resultant
    F_hyd, M_hyd, e_kp, e_abs,
    // Dimensioning
    gamma_f, F_dim, M_dim,
    // Manoeuvring
    mu, F_frict, F_lift, F_lower, psi, F_actuator, selfClosing,
    // Material
    gamma_m, f_yd,
    // Sealing
    tettelengde, F_seal_req,
    // Misc
    GAMMA_W,
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render() {
  renderMessages();
  renderStatusBar();
  if (errors.length === 0) {
    renderResultCards();
    renderTraceTable();
    renderFigure();
    renderCheck();
  } else {
    // Clear result areas
    ['hydro-cards','dim-cards','mano-cards','traceContent','checkContent',
     'capacityContent','warningsContent'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.innerHTML = '<p style="color:#94a3b8;font-size:12px;padding:8px">Rett feil i inndata for Ã¥ se resultater.</p>';
    });
    const canvas = document.getElementById('lukeCanvas');
    if (canvas) { const ctx = canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height); }
  }
}

function renderMessages() {
  const area = document.getElementById('msgArea');
  let html = '';
  errors.forEach(e => {
    html += `<div class="msg msg-err"><span class="icon">âŒ</span><span><strong>Feil:</strong> ${e.msg}</span></div>`;
  });
  warnings.forEach(w => {
    html += `<div class="msg msg-warn"><span class="icon">âš ï¸</span><span><strong>Advarsel:</strong> ${w}</span></div>`;
  });
  if (errors.length === 0 && warnings.length === 0) {
    html = '<div class="msg msg-ok"><span class="icon">âœ…</span><span>Inndata validert â€“ alle kontroller OK.</span></div>';
  }
  area.innerHTML = html;
}

function renderStatusBar() {
  const dot = document.getElementById('dot-input');
  const sbH = document.getElementById('sb-h');
  const sbF = document.getElementById('sb-F');
  const sbM = document.getElementById('sb-M');

  if (errors.length > 0) {
    dot.className = 'dot dot-red';
    dot.nextSibling && (dot.parentElement.childNodes[1].textContent = ' Feil i inndata');
    sbH.textContent = 'h = â€“ m';
    sbF.textContent = 'F_res = â€“ kN';
    sbM.textContent = 'Angrepspunkt = â€“ m';
    return;
  }
  dot.className = warnings.length > 0 ? 'dot dot-yellow' : 'dot dot-green';
  dot.parentElement.childNodes[1].textContent = warnings.length > 0 ? ` ${warnings.length} advarsel(er)` : ' Inndata OK';
  sbH.textContent = `Î”h = ${(state.h1 - state.h2).toFixed(2)} m`;
  sbF.textContent = `F_res = ${results.F_hyd ? results.F_hyd.toFixed(1) : 'â€“'} kN`;
  sbM.textContent = `Angrepspunkt = ${results.e_kp ? results.e_kp.toFixed(3) : 'â€“'} m over UK`;
}

function renderResultCards() {
  const r = results;
  const s = state;

  // â”€â”€ Hydrostatic cards â”€â”€
  document.getElementById('hydro-cards').innerHTML = `
    ${card('Trykk ved underkant (oppstr.)', fmt(r.p_UK1,2), 'kN/mÂ²', 'p_UK,1 = Î³Â·hâ‚', false)}
    ${card('Trykk ved overkant (oppstr.)', fmt(r.p_OK1,2), 'kN/mÂ²', 'p_OK,1 = Î³Â·max(hâ‚â€“H_L,0)', false)}
    ${card('Netto trykk ved UK', fmt(r.p_net_UK,2), 'kN/mÂ²', 'p_net_UK = p_UK,1 â€“ p_UK,2', false)}
    ${card('Netto trykk ved OK', fmt(r.p_net_OK,2), 'kN/mÂ²', 'p_net_OK = p_OK,1 â€“ p_OK,2', false)}
    ${card('Hydrostatisk resultant', fmt(r.F_hyd,2), 'kN', 'F_hyd (trapesfordeling)', true)}
    ${card('Angrepspunkt over UK', fmt(r.e_kp,3), 'm', 'e = HÂ·(2p_OK+p_UK)/[3(p_UK+p_OK)]', true)}
    ${card('Moment om underkant', fmt(r.M_hyd,2), 'kNÂ·m', 'M = F_hyd Ã— e', false)}
    ${card('Middeltrykk', fmt(r.p_avg,2), 'kN/mÂ²', 'p_avg = F_hyd / (BÃ—H_L)', false)}
  `;

  // â”€â”€ Dimensioning cards â”€â”€
  const lf_label = s.funksjon === 'tappe' ? `Î³_f = ${r.gamma_f} (tappeluke, NVE Â§2.5)` : `Î³_f = ${r.gamma_f} (NVE Tabell 2.1)`;
  document.getElementById('dim-cards').innerHTML = `
    ${card('Lastfaktor Î³_f', fmt(r.gamma_f,1), 'â€“', lf_label, false)}
    ${card('Dim. kraft F_dim', fmt(r.F_dim,2), 'kN', 'F_dim = Î³_f Ã— F_hyd', true)}
    ${card('Dim. moment M_dim', fmt(r.M_dim,2), 'kNÂ·m', 'M_dim = Î³_f Ã— M_hyd', false)}
  `;

  // â”€â”€ Manoeuvring cards â”€â”€
  const selfClsText = r.selfClosing ? 'âœ… Ja' : 'âŒ Nei';
  const selfClsCls  = r.selfClosing ? '' : 'warning-card';
  document.getElementById('mano-cards').innerHTML = `
    ${card('Friksjonsfaktor Î¼', fmt(r.mu,2), 'â€“', 'NVE Tabell 5.1 (minimumsverdi)', false)}
    ${card('Friksjonskraft', fmt(r.F_frict,2), 'kN', 'F_frict = Î¼ Ã— F_hyd', false)}
    ${card('NÃ¸dvendig lÃ¸ftekraft', fmt(r.F_lift,2), 'kN', 'F_lift = G + F_frict', true)}
    ${card('Aktuator-kapasitet (med Ïˆ)', fmt(r.F_actuator,2), 'kN', `Ïˆ = ${r.psi} (NVE Â§5.2, ${s.funksjon})`, true)}
    ${card('Senkekraft (netto)', fmt(r.F_lower,2), 'kN', 'F_lower = G â€“ F_frict', false)}
    ${cardRaw('Selvlukkende?', selfClsText, '', 'Netto lukkekraft > 25% av motkrefter (NVE Â§5.2)', selfClsCls)}
    ${card('Tettelengde (perimiter)', fmt(r.tettelengde,2), 'm', '2Ã—(B + H_L)', false)}
    ${card('Min. tetningskraft (flatgummi)', fmt(r.F_seal_req,1), 'kN', '5 kN/m Ã— tettelengde (NVE Â§5.2)', false)}
  `;
}

function card(label, value, unit, sub, highlight) {
  const cls = highlight ? 'result-card highlight' : 'result-card';
  return `<div class="${cls}">
    <div class="label">${label}</div>
    <div class="value">${value} <small style="font-size:12px;font-weight:400">${unit}</small></div>
    <div class="sub">${sub}</div>
  </div>`;
}
function cardRaw(label, value, unit, sub, extraCls) {
  return `<div class="result-card ${extraCls}">
    <div class="label">${label}</div>
    <div class="value">${value}</div>
    <div class="sub">${sub}</div>
  </div>`;
}
function fmt(v, dec) { return (v !== undefined && v !== null && !isNaN(v)) ? v.toFixed(dec) : 'â€“'; }

function renderTraceTable() {
  const r = results;
  const s = state;

  const rows = [
    {
      step: '1', name: 'Trykk ved underkant luke (oppstrÃ¸ms)',
      formula: 'p_UK,1 = Î³_w Â· hâ‚',
      values: `Î³_w = ${GAMMA_W} kN/mÂ³, hâ‚ = ${s.h1} m`,
      result: `p_UK,1 = ${fmt(r.p_UK1,3)} kN/mÂ²`,
      ref: 'NVE Â§2.2, Tabell 2.1'
    },
    {
      step: '2', name: 'Trykk ved overkant luke (oppstrÃ¸ms)',
      formula: 'p_OK,1 = Î³_w Â· max(hâ‚ â€“ H_L, 0)',
      values: `hâ‚ = ${s.h1} m, H_L = ${s.H_L} m â†’ h_top = ${fmt(r.h_top,3)} m`,
      result: `p_OK,1 = ${fmt(r.p_OK1,3)} kN/mÂ²`,
      ref: 'NVE Â§2.2'
    },
    {
      step: '3', name: 'Trykk nedstrÃ¸ms (UK og OK)',
      formula: 'p_UK,2 = Î³_w Â· hâ‚‚ ; p_OK,2 = Î³_w Â· max(hâ‚‚ â€“ H_L, 0)',
      values: `hâ‚‚ = ${s.h2} m`,
      result: `p_UK,2 = ${fmt(r.p_UK2,3)} kN/mÂ²,  p_OK,2 = ${fmt(r.p_OK2,3)} kN/mÂ²`,
      ref: 'NVE Â§2.2'
    },
    {
      step: '4', name: 'Netto trykkfordeling',
      formula: 'p_net = p_1 â€“ p_2  (UK og OK)',
      values: '',
      result: `p_net,UK = ${fmt(r.p_net_UK,3)} kN/mÂ²,  p_net,OK = ${fmt(r.p_net_OK,3)} kN/mÂ²`,
      ref: 'NVE Â§2.2'
    },
    {
      step: '5', name: 'Hydrostatisk resultantkraft (trapesfordeling)',
      formula: 'F_hyd = [(p_net,UK + p_net,OK) / 2] Â· B Â· H_L',
      values: `B = ${s.B} m, H_L = ${s.H_L} m`,
      result: `F_hyd = ${fmt(r.F_hyd,3)} kN`,
      ref: 'Hydrostatikk (standard formel)'
    },
    {
      step: '6', name: 'Angrepspunkt for resultant (over underkant)',
      formula: 'e = H_L Â· (2Â·p_net,OK + p_net,UK) / [3Â·(p_net,UK + p_net,OK)]',
      values: '',
      result: `e = ${fmt(r.e_kp,4)} m over underkant luke`,
      ref: 'Massesenter trapesfordeling'
    },
    {
      step: '7', name: 'Moment om underkant luke',
      formula: 'M_hyd = F_hyd Â· e',
      values: '',
      result: `M_hyd = ${fmt(r.M_hyd,3)} kNÂ·m`,
      ref: 'Statikk'
    },
    {
      step: '8', name: 'Lastfaktor (grensetilstand)',
      formula: s.funksjon === 'tappe'
        ? 'Î³_f = 1,4  (tappe-/flomluke, bruddgrense â€“ NVE spesialregel Â§2.5)'
        : 'Î³_f = 1,2  (standard permanent last, NVE Tabell 2.1)',
      values: `Grensetilstand: ${s.grensetilstand}, funksjon: ${s.funksjon}`,
      result: `Î³_f = ${fmt(r.gamma_f,1)}`,
      ref: 'NVE 1/2011 Â§2.5, Tabell 2.1'
    },
    {
      step: '9', name: 'Dimensjonerende kraft',
      formula: 'F_dim = Î³_f Â· F_hyd',
      values: '',
      result: `F_dim = ${fmt(r.F_dim,3)} kN`,
      ref: 'NVE 1/2011 Â§2.5'
    },
    {
      step: '10', name: 'Friksjonskraft (glidelister)',
      formula: 'F_frict = Î¼ Â· F_hyd',
      values: `Î¼ = ${r.mu} (${s.glideliste}, NVE Tabell 5.1 minimumsverdi)`,
      result: `F_frict = ${fmt(r.F_frict,3)} kN`,
      ref: 'NVE 1/2011 Â§5.2, Tabell 5.1'
    },
    {
      step: '11', name: 'NÃ¸dvendig lÃ¸ftekraft',
      formula: 'F_lift = G + F_frict',
      values: `G = ${s.G} kN (egenvekt), F_frict = ${fmt(r.F_frict,2)} kN`,
      result: `F_lift = ${fmt(r.F_lift,3)} kN`,
      ref: 'NVE 1/2011 Â§5.2'
    },
    {
      step: '12', name: 'NÃ¸dvendig aktuatorkapasitet (med paslagsfaktor)',
      formula: 'F_akt = Ïˆ Â· F_lift',
      values: `Ïˆ = ${r.psi} (NVE Â§5.2, ${s.funksjon}luke)`,
      result: `F_akt = ${fmt(r.F_actuator,3)} kN`,
      ref: 'NVE 1/2011 Â§5.2'
    },
    {
      step: '13', name: 'Dimensjonerende flytegrense (stÃ¥l)',
      formula: 'f_yd = (R_e Â· 0,8) / Î³_m  [NVE Â§4.2: begrenset til 80% av Rm]',
      values: `R_e = ${s.Re} MPa, Î³_m = ${r.gamma_m} (med plastisitetsreserve, NVE Tabell 4.1)`,
      result: `f_yd = ${fmt(r.f_yd,1)} MPa`,
      ref: 'NVE 1/2011 Â§4.2, Tabell 4.1'
    },
  ];

  let html = `<table class="trace-table">
    <thead><tr><th>#</th><th>Beregningstrinn</th><th>Formel</th><th>Verdier</th><th>Resultat</th><th>Referanse</th></tr></thead><tbody>`;
  rows.forEach(r => {
    html += `<tr>
      <td>${r.step}</td>
      <td>${r.name}</td>
      <td class="formula">${r.formula}</td>
      <td>${r.values}</td>
      <td class="num">${r.result}</td>
      <td class="ref">${r.ref}</td>
    </tr>`;
  });
  html += '</tbody></table>';
  document.getElementById('traceContent').innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIGURE â€“ Canvas drawing  (stor, informativ versjon)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderFigure() {
  const canvas = document.getElementById('lukeCanvas');
  const ctx    = canvas.getContext('2d');
  const W = canvas.width;   // 900
  const H = canvas.height;  // 620
  ctx.clearRect(0, 0, W, H);
  const s = state, r = results;

  const mg = { left: 70, right: 260, top: 50, bottom: 70 };
  const drawH = H - mg.top - mg.bottom;
  const gateW = 56;
  const gateX = mg.left + (W - mg.left - mg.right) * 0.42;
  const gateL = gateX - gateW / 2;
  const gateR = gateX + gateW / 2;
  const maxH  = Math.max(s.h1 * 1.15, s.H_L * 1.4, 1);
  const scale = drawH / maxH;
  const originY = H - mg.bottom;
  function toY(h) { return originY - h * scale; }

  const y_UK = toY(0), y_OK = toY(s.H_L);
  const y_h1 = toY(s.h1), y_h2 = toY(Math.max(s.h2, 0));
  const y_res = toY(r.e_kp);
  const pressZoneW = gateL - mg.left - 16;
  const pMaxVal = Math.max(r.p_net_UK, 0.01);
  const pW_UK = Math.min((r.p_net_UK / pMaxVal) * pressZoneW * 0.88, pressZoneW);
  const pW_OK = Math.min((r.p_net_OK / pMaxVal) * pressZoneW * 0.88, pressZoneW);

  // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function arrowFn(x1, y1, x2, y2, color, lw, hl) {
    lw = lw||2; hl = hl||10;
    const ang = Math.atan2(y2-y1, x2-x1);
    ctx.save(); ctx.strokeStyle=color; ctx.fillStyle=color; ctx.lineWidth=lw;
    ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(x2,y2);
    ctx.lineTo(x2-hl*Math.cos(ang-0.38), y2-hl*Math.sin(ang-0.38));
    ctx.lineTo(x2-hl*Math.cos(ang+0.38), y2-hl*Math.sin(ang+0.38));
    ctx.closePath(); ctx.fill(); ctx.restore();
  }
  function dblArrow(x1,y1,x2,y2,color,lw) { arrowFn(x1,y1,x2,y2,color,lw||1.5,7); arrowFn(x2,y2,x1,y1,color,lw||1.5,7); }
  function dimLine(x1,y1,x2,y2,lbl,side,color) {
    color=color||'#475569';
    ctx.save(); ctx.strokeStyle=color; ctx.fillStyle=color; ctx.lineWidth=1;
    const dy=x2-x1===0?6:0, dx=y2-y1===0?6:0;
    ctx.setLineDash([]);
    ctx.beginPath(); ctx.moveTo(x1-dy*0.5,y1+dx*0.5); ctx.lineTo(x1+dy,y1-dx); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(x2-dy*0.5,y2+dx*0.5); ctx.lineTo(x2+dy,y2-dx); ctx.stroke();
    dblArrow(x1,y1,x2,y2,color,1.5);
    ctx.font='bold 12px Consolas'; ctx.textBaseline='middle';
    const mx=(x1+x2)/2, my=(y1+y2)/2, off=14;
    let tx=mx, ty=my;
    if(side==='right'){tx=mx+off;ctx.textAlign='left';}
    else if(side==='left'){tx=mx-off;ctx.textAlign='right';}
    else if(side==='top'){ty=my-off;ctx.textAlign='center';}
    else{ty=my+off;ctx.textAlign='center';}
    ctx.strokeStyle='white'; ctx.lineWidth=3; ctx.strokeText(lbl,tx,ty);
    ctx.fillText(lbl,tx,ty); ctx.restore();
  }
  function lbl(text,x,y,opts) {
    opts=opts||{};
    ctx.save();
    ctx.font=(opts.bold?'bold ':''+(opts.size||13))+'px '+(opts.mono?'Consolas':'Segoe UI');
    ctx.fillStyle=opts.color||'#1e293b';
    ctx.textAlign=opts.align||'left'; ctx.textBaseline=opts.base||'middle';
    if(opts.halo!==false){ctx.strokeStyle=opts.haloclr||'white';ctx.lineWidth=3.5;ctx.strokeText(text,x,y);}
    ctx.fillText(text,x,y); ctx.restore();
  }

  // â”€â”€ Background â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ctx.fillStyle='#f0f4f8'; ctx.fillRect(0,0,W,H);
  ctx.fillStyle='#ffffff'; ctx.fillRect(mg.left-10,mg.top-10,W-mg.left-mg.right+70,drawH+20);

  // â”€â”€ Upstream water â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(s.h1>0){
    const g=ctx.createLinearGradient(0,y_h1,0,y_UK);
    g.addColorStop(0,'rgba(37,99,200,0.07)'); g.addColorStop(1,'rgba(37,99,200,0.20)');
    ctx.fillStyle=g; ctx.fillRect(mg.left,y_h1,gateL-mg.left,y_UK-y_h1);
  }
  // â”€â”€ Downstream water â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const rwX=W-mg.right+50;
  if(s.h2>0.01){
    const g2=ctx.createLinearGradient(0,y_h2,0,y_UK);
    g2.addColorStop(0,'rgba(37,99,200,0.05)'); g2.addColorStop(1,'rgba(37,99,200,0.14)');
    ctx.fillStyle=g2; ctx.fillRect(gateR,y_h2,rwX-gateR,y_UK-y_h2);
  }
  // â”€â”€ Channel floor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ctx.fillStyle='#cbd5e1'; ctx.fillRect(mg.left,y_UK,rwX-mg.left+10,10);
  ctx.strokeStyle='#94a3b8'; ctx.lineWidth=1;
  for(let xx=mg.left;xx<rwX+10;xx+=14){ctx.beginPath();ctx.moveTo(xx,y_UK+10);ctx.lineTo(xx+10,y_UK+20);ctx.stroke();}
  // â”€â”€ Walls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ctx.strokeStyle='#334155'; ctx.lineWidth=2.5; ctx.setLineDash([]);
  ctx.beginPath(); ctx.moveTo(mg.left,mg.top-5); ctx.lineTo(mg.left,y_UK); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(rwX,mg.top-5); ctx.lineTo(rwX,y_UK); ctx.stroke();
  ctx.strokeStyle='#94a3b8'; ctx.lineWidth=1;
  for(let yy=mg.top;yy<y_UK;yy+=16){ctx.beginPath();ctx.moveTo(mg.left,yy);ctx.lineTo(mg.left-10,yy+10);ctx.stroke();}
  for(let yy=mg.top;yy<y_UK;yy+=16){ctx.beginPath();ctx.moveTo(rwX,yy);ctx.lineTo(rwX+10,yy+10);ctx.stroke();}

  // â”€â”€ Pressure trapezoid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(r.F_hyd>0.01){
    const px_UK=gateL-pW_UK, px_OK=gateL-pW_OK;
    const pf=ctx.createLinearGradient(px_UK,0,gateL,0);
    pf.addColorStop(0,'rgba(37,99,200,0.08)'); pf.addColorStop(1,'rgba(37,99,200,0.28)');
    ctx.fillStyle=pf;
    ctx.beginPath(); ctx.moveTo(gateL,y_UK); ctx.lineTo(px_UK,y_UK); ctx.lineTo(px_OK,y_OK); ctx.lineTo(gateL,y_OK); ctx.closePath(); ctx.fill();
    ctx.strokeStyle='#1d4ed8'; ctx.lineWidth=2; ctx.setLineDash([]);
    ctx.beginPath(); ctx.moveTo(px_UK,y_UK); ctx.lineTo(gateL,y_UK); ctx.moveTo(px_OK,y_OK); ctx.lineTo(gateL,y_OK); ctx.moveTo(px_UK,y_UK); ctx.lineTo(px_OK,y_OK); ctx.stroke();
    const nA=Math.max(4,Math.min(9,Math.round((y_UK-y_OK)/35)));
    for(let i=0;i<=nA;i++){
      const frac=i/nA, yA=y_OK+(y_UK-y_OK)*frac;
      const pH=r.p_net_OK+(r.p_net_UK-r.p_net_OK)*frac;
      const xA=gateL-(pH/pMaxVal)*pressZoneW*0.88;
      arrowFn(xA,yA,gateL-1,yA,'#2563a8',1.5,7);
    }
    // Pressure value labels
    lbl(r.p_net_UK.toFixed(1)+' kN/mÂ²',px_UK-6,y_UK-1,{color:'#1d4ed8',mono:true,size:12,align:'right',base:'bottom',bold:true});
    if(r.p_net_OK>0.1) lbl(r.p_net_OK.toFixed(1)+' kN/mÂ²',px_OK-6,y_OK+1,{color:'#1d4ed8',mono:true,size:12,align:'right',base:'top',bold:true});

    // Resultant F_hyd arrow
    arrowFn(px_UK-30,y_res,gateL+3,y_res,'#e07b00',3.5,13);
    // F_hyd callout box (right of gate)
    const bx=gateR+16, by=y_res-28;
    ctx.save(); ctx.fillStyle='#fff7ed'; ctx.strokeStyle='#e07b00'; ctx.lineWidth=1.5;
    rrect(ctx,bx,by,215,54,5); ctx.fill(); ctx.stroke(); ctx.restore();
    lbl('F_hyd = '+r.F_hyd.toFixed(2)+' kN',bx+10,by+15,{color:'#c2410c',mono:true,size:13,bold:true});
    lbl('e = '+r.e_kp.toFixed(3)+' m over UK',bx+10,by+35,{color:'#92400e',mono:true,size:12});
    ctx.setLineDash([5,4]); ctx.strokeStyle='#e07b00'; ctx.lineWidth=1.2;
    ctx.beginPath(); ctx.moveTo(gateL-pW_UK-10,y_res); ctx.lineTo(bx+215,y_res); ctx.stroke(); ctx.setLineDash([]);
    ctx.fillStyle='#e07b00'; ctx.beginPath(); ctx.arc(gateL,y_res,5,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='#fff'; ctx.lineWidth=1.5; ctx.beginPath(); ctx.arc(gateL,y_res,5,0,Math.PI*2); ctx.stroke();
  }

  // â”€â”€ Egenvekt G â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(s.G>0.01){
    const gax=gateX, gay1=y_OK-55, gay2=y_OK-4;
    arrowFn(gax,gay1,gax,gay2,'#15803d',3,11);
    const gbx=gateX+10;
    ctx.save(); ctx.fillStyle='#f0fdf4'; ctx.strokeStyle='#15803d'; ctx.lineWidth=1.5;
    rrect(ctx,gbx,gay1-12,130,28,4); ctx.fill(); ctx.stroke(); ctx.restore();
    lbl('G = '+s.G.toFixed(1)+' kN',gbx+8,gay1+2,{color:'#15803d',mono:true,size:12,bold:true});
  }

  // â”€â”€ Gate body â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const gg=ctx.createLinearGradient(gateL,0,gateR,0);
  gg.addColorStop(0,'#334155'); gg.addColorStop(0.25,'#64748b'); gg.addColorStop(0.75,'#64748b'); gg.addColorStop(1,'#334155');
  ctx.fillStyle=gg; ctx.fillRect(gateL,y_OK,gateW,y_UK-y_OK);
  ctx.strokeStyle='#0f172a'; ctx.lineWidth=2.5; ctx.setLineDash([]);
  ctx.strokeRect(gateL,y_OK,gateW,y_UK-y_OK);
  ctx.strokeStyle='rgba(255,255,255,0.15)'; ctx.lineWidth=1;
  for(let yy=y_OK+8;yy<y_UK-2;yy+=14){ctx.beginPath();ctx.moveTo(gateL+3,yy);ctx.lineTo(gateR-3,yy);ctx.stroke();}
  if(y_UK-y_OK>28){ctx.fillStyle='white';ctx.font='bold 11px Segoe UI';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('GLIDELUKE',gateX,(y_OK+y_UK)/2);}
  // Glidelister
  const gsH=Math.min(y_UK-y_OK,200), gsY=(y_OK+y_UK)/2-gsH/2;
  ctx.fillStyle='#94a3b8'; ctx.fillRect(gateL-6,gsY,6,gsH); ctx.fillRect(gateR,gsY,6,gsH);
  ctx.strokeStyle='#475569'; ctx.lineWidth=1;
  ctx.strokeRect(gateL-6,gsY,6,gsH); ctx.strokeRect(gateR,gsY,6,gsH);

  // â”€â”€ Water surfaces â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ctx.strokeStyle='#1d4ed8'; ctx.lineWidth=2.5; ctx.setLineDash([8,4]);
  ctx.beginPath(); ctx.moveTo(mg.left,y_h1); ctx.lineTo(gateL,y_h1); ctx.stroke(); ctx.setLineDash([]);
  drawWave(ctx,mg.left+14,y_h1,'#1d4ed8');
  lbl('hâ‚ = '+s.h1.toFixed(2)+' m  (HRV)',mg.left+38,y_h1-10,{color:'#1d4ed8',bold:true,size:13});
  if(s.h2>0.01){
    ctx.strokeStyle='#0369a1'; ctx.lineWidth=2; ctx.setLineDash([6,4]);
    ctx.beginPath(); ctx.moveTo(gateR,y_h2); ctx.lineTo(rwX,y_h2); ctx.stroke(); ctx.setLineDash([]);
    drawWave(ctx,gateR+10,y_h2,'#0369a1');
    lbl('hâ‚‚ = '+s.h2.toFixed(2)+' m',gateR+36,y_h2-10,{color:'#0369a1',bold:true,size:13});
  } else {
    lbl('TÃ¸rt nedstrÃ¸ms',gateR+14,(y_OK+y_UK)/2+20,{color:'#94a3b8',size:12});
  }

  // â”€â”€ Dimension lines â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  dimLine(gateR+42,y_OK,gateR+42,y_UK,'H_L = '+s.H_L.toFixed(2)+' m','right','#334155');
  if(s.h1>0) dimLine(mg.left-32,y_h1,mg.left-32,y_UK,s.h1.toFixed(2)+' m','left','#1d4ed8');
  if(s.h2>0.01) dimLine(rwX+30,y_h2,rwX+30,y_UK,s.h2.toFixed(2)+' m','right','#0369a1');
  dimLine(gateL,y_UK+32,gateR,y_UK+32,'B = '+s.B.toFixed(2)+' m','bottom','#334155');
  if(r.F_hyd>0.01) dimLine(gateL-10,y_UK,gateL-10,y_res,'e = '+r.e_kp.toFixed(3)+' m','left','#e07b00');

  // â”€â”€ F_lift: arrow upward, LEFT of gate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const liftX=gateL-28, liftY1=y_OK-6;
  const liftLen=Math.min(65,Math.max(30,r.F_lift*0.8)), liftY2=liftY1-liftLen;
  arrowFn(liftX,liftY1,liftX,liftY2,'#7c3aed',2.5,10);
  const lbW=148,lbH=28,lbX=liftX-lbW-6,lbY=liftY2-lbH/2;
  ctx.save(); ctx.fillStyle='#f5f3ff'; ctx.strokeStyle='#7c3aed'; ctx.lineWidth=1.5;
  rrect(ctx,lbX,lbY,lbW,lbH,4); ctx.fill(); ctx.stroke(); ctx.restore();
  ctx.save(); ctx.strokeStyle='#7c3aed'; ctx.lineWidth=1; ctx.setLineDash([3,3]);
  ctx.beginPath(); ctx.moveTo(lbX+lbW,lbY+lbH/2); ctx.lineTo(liftX,liftY2); ctx.stroke(); ctx.setLineDash([]); ctx.restore();
  lbl('F_lift = '+r.F_lift.toFixed(1)+' kN',lbX+lbW/2,lbY+lbH/2,{color:'#5b21b6',mono:true,size:12,bold:true,align:'center'});

  // â”€â”€ F_frict: arrow downward, RIGHT of gate, BELOW F_hyd box â”€â”€
  const frX=gateR+28;
  const frY1=Math.min(y_res+55, y_UK-30);
  const frLen=Math.min(50,Math.max(22,r.F_frict*0.65));
  const frY2=Math.min(frY1+frLen, y_UK+2);
  arrowFn(frX,frY1,frX,frY2,'#be185d',2.5,10);
  const fbW=148,fbH=28,fbX=frX+8,fbY=(frY1+frY2)/2-fbH/2;
  ctx.save(); ctx.fillStyle='#fdf2f8'; ctx.strokeStyle='#be185d'; ctx.lineWidth=1.5;
  rrect(ctx,fbX,fbY,fbW,fbH,4); ctx.fill(); ctx.stroke(); ctx.restore();
  ctx.save(); ctx.strokeStyle='#be185d'; ctx.lineWidth=1; ctx.setLineDash([3,3]);
  ctx.beginPath(); ctx.moveTo(fbX,fbY+fbH/2); ctx.lineTo(frX,frY1+(frY2-frY1)/2); ctx.stroke(); ctx.setLineDash([]); ctx.restore();
  lbl('F_fr = '+r.F_frict.toFixed(1)+' kN',fbX+fbW/2,fbY+fbH/2,{color:'#9d174d',mono:true,size:12,bold:true,align:'center'});

  // â”€â”€ Depth axis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const axX=mg.left-52;
  ctx.strokeStyle='#94a3b8'; ctx.lineWidth=1; ctx.setLineDash([]);
  ctx.beginPath(); ctx.moveTo(axX,mg.top); ctx.lineTo(axX,y_UK); ctx.stroke();
  const ts=maxH>30?10:maxH>15?5:maxH>6?2:1;
  for(let h=0;h<=maxH+0.01;h+=ts){
    const ty=toY(h);
    if(ty<mg.top||ty>y_UK+2) continue;
    ctx.beginPath(); ctx.moveTo(axX-5,ty); ctx.lineTo(axX,ty); ctx.stroke();
    lbl(h.toFixed(0)+' m',axX-8,ty,{color:'#64748b',size:11,mono:true,align:'right',halo:false});
  }
  ctx.save(); ctx.translate(axX-22,(mg.top+y_UK)/2); ctx.rotate(-Math.PI/2);
  ctx.font='11px Segoe UI'; ctx.fillStyle='#94a3b8'; ctx.textAlign='center'; ctx.fillText('Dybde (m)',0,0); ctx.restore();

  // â”€â”€ Legend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const legX=W-mg.right+20, legY=mg.top+10, legW=mg.right-30;
  ctx.save(); ctx.fillStyle='white'; ctx.strokeStyle='#e2e8f0'; ctx.lineWidth=1;
  rrect(ctx,legX-8,legY-8,legW,195,6); ctx.fill(); ctx.stroke(); ctx.restore();
  const legItems=[
    {color:'#2563a8',lw:3,dash:[],text:'Netto trykkfordeling'},
    {color:'#e07b00',lw:3,dash:[],text:'Resultant F_hyd'},
    {color:'#15803d',lw:3,dash:[],text:'Egenvekt G'},
    {color:'#7c3aed',lw:3,dash:[],text:'LÃ¸ftekraft F_lift'},
    {color:'#be185d',lw:2,dash:[],text:'Friksjonskraft F_frict'},
    {color:'#1d4ed8',lw:2,dash:[8,4],text:'Vannflate (oppstrÃ¸ms)'},
    {color:'#0369a1',lw:2,dash:[6,4],text:'Vannflate (nedstrÃ¸ms)'},
  ];
  lbl('Tegnforklaring',legX,legY+4,{bold:true,size:12,color:'#1e293b'});
  legItems.forEach((it,i)=>{
    const ly=legY+26+i*24;
    ctx.save(); ctx.strokeStyle=it.color; ctx.lineWidth=it.lw; ctx.setLineDash(it.dash||[]);
    ctx.beginPath(); ctx.moveTo(legX,ly); ctx.lineTo(legX+30,ly); ctx.stroke(); ctx.restore();
    lbl(it.text,legX+36,ly,{color:'#334155',size:11,halo:false});
  });

  // â”€â”€ Dimensjonerende laster â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const lfY=legY+200;
  ctx.save(); ctx.fillStyle='#eff6ff'; ctx.strokeStyle='#2563a8'; ctx.lineWidth=1.5;
  rrect(ctx,legX-8,lfY,legW,100,5); ctx.fill(); ctx.stroke(); ctx.restore();
  lbl('Dimensjonerende laster',legX,lfY+14,{bold:true,size:12,color:'#1e293b'});
  lbl('Î³_f = '+r.gamma_f.toFixed(1)+'  (NVE Â§2.5)',legX,lfY+34,{mono:true,size:12,color:'#1d4ed8'});
  lbl('F_dim = '+r.F_dim.toFixed(1)+' kN',legX,lfY+54,{mono:true,size:12,color:'#c2410c',bold:true});
  lbl('F_akt = '+r.F_actuator.toFixed(1)+' kN  (Ïˆ='+r.psi+')',legX,lfY+74,{mono:true,size:12,color:'#7c3aed'});

  // â”€â”€ Title â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ctx.save(); ctx.fillStyle='#1a3a5c'; ctx.font='bold 15px Segoe UI'; ctx.textAlign='center';
  ctx.fillText('Glideluke â€“ Hydrostatisk trykkfordeling og krefter',W/2,22); ctx.restore();

  document.getElementById('figCaption').textContent =
    'Netto hydrostatisk kraft F_hyd = '+r.F_hyd.toFixed(2)+' kN  |  '+
    'Angrepspunkt e = '+r.e_kp.toFixed(3)+' m over underkant  |  '+
    'Dim. kraft F_dim = '+r.F_dim.toFixed(2)+' kN (Î³_f = '+r.gamma_f+')  |  '+
    'LÃ¸ftekraft F_lift = '+r.F_lift.toFixed(2)+' kN';
}

function rrect(ctx,x,y,w,h,r){
  ctx.beginPath(); ctx.moveTo(x+r,y);
  ctx.lineTo(x+w-r,y); ctx.arcTo(x+w,y,x+w,y+r,r);
  ctx.lineTo(x+w,y+h-r); ctx.arcTo(x+w,y+h,x+w-r,y+h,r);
  ctx.lineTo(x+r,y+h); ctx.arcTo(x,y+h,x,y+h-r,r);
  ctx.lineTo(x,y+r); ctx.arcTo(x,y,x+r,y,r); ctx.closePath();
}
function drawWave(ctx,x,y,color){
  ctx.save(); ctx.strokeStyle=color; ctx.lineWidth=2; ctx.setLineDash([]);
  ctx.beginPath(); ctx.moveTo(x,y);
  ctx.bezierCurveTo(x+4,y-5,x+8,y-5,x+12,y);
  ctx.bezierCurveTo(x+16,y+5,x+20,y+5,x+24,y);
  ctx.stroke(); ctx.restore();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHECK TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCheck() {
  const r = results;
  const s = state;

  // â”€â”€ Validity / prerequisites â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const checks = [
    {
      ok: s.h1 <= 300,
      label: 'TrykkhÃ¸yde innenfor vanlig omrÃ¥de',
      detail: `hâ‚ = ${s.h1} m â‰¤ 300 m`,
      ref: '',
    },
    {
      ok: s.B <= 30 && s.H_L <= 30,
      label: 'Lukedimensjoner innenfor vanlig omrÃ¥de',
      detail: `B = ${s.B} m, H_L = ${s.H_L} m`,
      ref: '',
    },
    {
      ok: s.h1 <= 20 || true,  // just informational
      label: s.h1 <= 20 ? 'Trykk â‰¤ 20 m: kavitasjon/vibrasjon normalt uproblematisk'
                        : (s.h1 <= 40 ? 'Trykk 20â€“40 m: luft nedstrÃ¸ms mÃ¥ vurderes' : 'Trykk > 40 m: spesiell utforming NÃ˜DVENDIG'),
      detail: `hâ‚ = ${s.h1} m (NVE C.4: > 20 m krever vurdering, > 40 m spesialkrav)`,
      ref: 'NVE 1/2011 C.4',
      warn: s.h1 > 20 && s.h1 <= 40,
      fail: s.h1 > 40,
    },
    {
      ok: r.p_net_UK >= 0,
      label: 'Netto trykk positivt (oppstrÃ¸ms > nedstrÃ¸ms)',
      detail: `p_net,UK = ${fmt(r.p_net_UK,2)} kN/mÂ²`,
      ref: 'NVE Â§2.2',
    },
    {
      ok: s.funksjon !== 'tappe' || r.gamma_f === 1.4,
      label: 'Lastfaktor 1,4 anvendt for tappeluke (NVE spesialregel)',
      detail: `Î³_f = ${r.gamma_f} (${s.grensetilstand})`,
      ref: 'NVE 1/2011 Â§2.5',
    },
    {
      ok: true,
      label: `Glidelistmateriale: ${s.glideliste} â€“ Î¼ = ${r.mu}`,
      detail: `NVE minimumsverdier for friksjonsfaktor (Tabell 5.1)`,
      ref: 'NVE 1/2011 Â§5.2, Tabell 5.1',
    },
    {
      ok: r.selfClosing,
      warn: !r.selfClosing,
      label: r.selfClosing
        ? 'Luken er selvlukkende (netto lukkekraft > 25 % av motkrefter)'
        : 'Luken er IKKE selvlukkende â€“ manÃ¸vreringskraft til lukking nÃ¸dvendig',
      detail: `F_lower = ${fmt(r.F_lower,2)} kN`,
      ref: 'NVE 1/2011 Â§5.2',
    },
  ];

  let html = '';
  checks.forEach(c => {
    const icon  = c.fail ? 'âŒ' : (c.warn ? 'âš ï¸' : 'âœ…');
    const cls   = c.fail ? 'msg-err' : (c.warn ? 'msg-warn' : 'msg-ok');
    html += `<div class="msg ${cls}">
      <span class="icon">${icon}</span>
      <span><strong>${c.label}</strong><br>
        <span style="font-size:11px">${c.detail}</span>
        ${c.ref ? `<span class="ref-badge">${c.ref}</span>` : ''}
      </span>
    </div>`;
  });
  document.getElementById('checkContent').innerHTML = html;

  // â”€â”€ Capacity hint (simplified) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const capHtml = `
    <div class="msg msg-ok">
      <span class="icon">â„¹ï¸</span>
      <span>
        <strong>Dimensjonerende flytegrense stÃ¥l:</strong>
        f_yd = (R_e Ã— 0,8) / Î³_m = (${s.Re} Ã— 0,8) / ${r.gamma_m} = <strong>${fmt(r.f_yd,1)} MPa</strong>
        <span class="ref-badge">NVE Â§4.2 + Tabell 4.1</span><br>
        <span style="font-size:11px">
          Kapasitetskontroll av platekasse, bjelker og forbindelser gjÃ¸res mot
          dimensjonerende kraft F_dim = ${fmt(r.F_dim,2)} kN og moment M_dim = ${fmt(r.M_dim,2)} kNÂ·m.
          Korrosjonstillegg: trekk fra 1 mm per korrosjonsutsatt flate (NVE Â§4.2).
        </span>
      </span>
    </div>
    <div class="msg msg-ok">
      <span class="icon">â„¹ï¸</span>
      <span>
        <strong>Flatetrykk for glidelister</strong> (NVE Â§5.2):<br>
        <span style="font-size:11px">
          â€¢ Bronseglideliste mot rustfritt stÃ¥l: maks 14,0 MPa<br>
          â€¢ Polyamidglideliste mot rustfritt stÃ¥l: maks 10,0 MPa<br>
          â€¢ InnstÃ¸pt stÃ¥l mot betong: skjÃ¦r â‰¤ 0,5 MPa, trykk â‰¤ 15,0 MPa
        </span>
      </span>
    </div>
  `;
  document.getElementById('capacityContent').innerHTML = capHtml;

  // â”€â”€ Warnings content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let warnHtml = '';
  if (warnings.length === 0) {
    warnHtml = '<div class="msg msg-ok"><span class="icon">âœ…</span><span>Ingen spesielle advarsler.</span></div>';
  } else {
    warnings.forEach(w => {
      warnHtml += `<div class="msg msg-warn"><span class="icon">âš ï¸</span><span>${w}</span></div>`;
    });
  }
  // Always add standard notes
  warnHtml += `
    <div class="msg msg-warn">
      <span class="icon">ğŸ“‹</span>
      <span>
        <strong>GyldighetsomrÃ¥de for dette verktÃ¸yet:</strong><br>
        <span style="font-size:11px">
          BeregningsverktÃ¸yet dekker hydrostatisk kraftberegning og manÃ¸vreringskrefter for
          rektangulÃ¦re glideluker med uniform bredde. Det forutsetter stasjonÃ¦r tilstand (ikke hydrodynamiske
          trykk fra strÃ¸mmende vann). Dynamiske laster, vibrasjon, kavitasjon, luftingsbehov og strukturdimensjonering
          (platetykkelse, bjelkekonstruksjon) er brukerens ansvar og mÃ¥ beregnes separat.
          Utmatting skal kontrolleres iht. NVE Vedlegg B for luker med mange belastningsvekslinger.
        </span>
        <span class="ref-badge">NVE 1/2011 C.1, C.4, Vedlegg B</span>
      </span>
    </div>
    <div class="msg msg-warn">
      <span class="icon">ğŸ“‹</span>
      <span>
        <strong>Lufting nedstrÃ¸ms:</strong><br>
        <span style="font-size:11px">
          Behov for lufttilfÃ¸rsel nedstrÃ¸ms tappeluke skal alltid vurderes (NVE Â§5.1).
          For trykkdifferanse &gt; 20 m gjelder spesielle krav til luftearrangement (NVE C.1).
          Lufthastighet i lufterÃ¸r maks ca. 50 m/s.
        </span>
      </span>
    </div>
  `;
  document.getElementById('warningsContent').innerHTML = warnHtml;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TAB SWITCHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showTab(name) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  event.target.classList.add('active');
  if (name === 'figure' && errors.length === 0) renderFigure();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INITIAL CALCULATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
onInputChange();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RAPPORT â€“ Word-eksport
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function buildReportHTML(embed) {
  // embed=true: inline base64 figure for Word; false: for preview
  const s = state;
  const r = results;
  const now = new Date();
  const dato = now.toLocaleDateString('nb-NO', {day:'2-digit',month:'2-digit',year:'numeric'});
  const prosjekt = document.getElementById('rpt-prosjekt').value || '(ikke angitt)';
  const autor    = document.getElementById('rpt-autor').value    || '(ikke angitt)';
  const dokref   = document.getElementById('rpt-dokref').value   || 'â€“';

  const funksjonLabel = {tappe:'Tappeluke / stengeorgan', flom:'Flomluke', inntak:'Inntaksluke'}[s.funksjon];
  const driftLabel    = {stengt:'Stengt â€“ fullt hydrostatisk trykk', apning:'Ã…pning â€“ trykk-belastet', mellom:'Mellomstilling â€“ regulering'}[s.driftstilstand];
  const glideLabel    = {bronse:'Bronse mot rustfritt stÃ¥l (Î¼ = 0,60)', polymer:'Polymer/polyamid mot rustfritt stÃ¥l (Î¼ = 0,40)', spesial:'Spesialglidelager (Î¼ = 0,15)'}[s.glideliste];
  const grensetLabel  = {brudd:'Bruddgrensetilstand (ULS)', ulykke:'Ulykkesgrensetilstand (ALS)', bruks:'Bruksgrensetilstand (SLS)'}[s.grensetilstand];

  // Capture figure as base64
  let figImg = '';
  try {
    renderFigure();
    const canvas = document.getElementById('lukeCanvas');
    figImg = canvas.toDataURL('image/png');
  } catch(e) {}

  const warningRows = warnings.length > 0
    ? warnings.map(w=>`<tr><td style="color:#92400e;padding:4px 8px;">âš  ${w}</td></tr>`).join('')
    : '<tr><td style="color:#166534;padding:4px 8px;">âœ“ Ingen advarsler</td></tr>';

  return `<!DOCTYPE html>
<html xmlns:o="urn:schemas-microsoft-com:office:office"
      xmlns:w="urn:schemas-microsoft-com:office:word"
      xmlns="http://www.w3.org/TR/REC-html40">
<head>
<meta charset="UTF-8">
<title>Beregningsrapport â€“ Glideluke</title>
<!--[if gte mso 9]>
<xml><w:WordDocument><w:View>Print</w:View><w:Zoom>100</w:Zoom></w:WordDocument></xml>
<![endif]-->
<style>
  @page { size: A4; margin: 2.5cm 2.5cm 2.5cm 2.5cm; }
  body  { font-family: Calibri, Arial, sans-serif; font-size: 11pt; color: #1e293b; line-height: 1.5; }
  h1    { font-size: 18pt; color: #1a3a5c; border-bottom: 3px solid #1a3a5c; padding-bottom: 6pt; margin-top: 0; }
  h2    { font-size: 13pt; color: #1a3a5c; border-bottom: 1pt solid #94a3b8; padding-bottom: 3pt; margin-top: 18pt; }
  h3    { font-size: 11pt; color: #334155; margin-top: 12pt; margin-bottom: 4pt; }
  table { border-collapse: collapse; width: 100%; margin-bottom: 10pt; font-size: 10.5pt; }
  th    { background: #1a3a5c; color: white; padding: 5pt 8pt; text-align: left; font-weight: bold; }
  td    { padding: 4pt 8pt; border-bottom: 0.5pt solid #e2e8f0; vertical-align: top; }
  tr:nth-child(even) td { background: #f8fafc; }
  .val  { font-family: Consolas, monospace; font-weight: bold; color: #1a3a5c; }
  .formula { font-family: Consolas, monospace; font-size: 10pt; color: #2563a8; }
  .ref  { font-size: 9.5pt; color: #64748b; }
  .highlight { background: #dbeafe !important; }
  .warn { background: #fef3c7 !important; color: #92400e; }
  .ok   { background: #dcfce7 !important; color: #166534; }
  .meta-table td { border: none; padding: 2pt 8pt; }
  .meta-table td:first-child { color: #64748b; width: 140pt; }
  .meta-table td:last-child  { font-weight: bold; }
  .note { background: #f0f4f8; border-left: 3pt solid #2563a8; padding: 8pt 10pt; font-size: 10pt; margin: 10pt 0; }
  .figure-box { text-align: center; margin: 16pt 0; }
  .figure-box img { max-width: 100%; border: 1pt solid #e2e8f0; }
  .figure-box figcaption { font-size: 9pt; color: #64748b; margin-top: 4pt; font-style: italic; }
  .page-break { page-break-before: always; }
  .footer-line { border-top: 1pt solid #e2e8f0; margin-top: 20pt; padding-top: 6pt; font-size: 9pt; color: #94a3b8; }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FORSIDE / HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<h1>Beregningsrapport â€“ Glideluke (tappe- og stengeorgan)</h1>

<table class="meta-table">
  <tr><td>Prosjekt:</td>      <td>${prosjekt}</td></tr>
  <tr><td>Utarbeidet av:</td> <td>${autor}</td></tr>
  <tr><td>Dokumentnr.:</td>   <td>${dokref}</td></tr>
  <tr><td>Dato:</td>          <td>${dato}</td></tr>
  <tr><td>Beregningsgrunnlag:</td><td>NVE Retningslinjer 1/2011 â€“ Stenge- og tappeorganer, ror og tverrslagsporter</td></tr>
  <tr><td>BeregningsverktÃ¸y:</td><td>Glideluke-kalkulator v1.0 (HTML/JS, NVE 1/2011)</td></tr>
</table>

<div class="note">
  <strong>FormÃ¥l:</strong> Beregning av hydrostatiske krefter, resultant og angrepspunkt, dimensjonerende laster samt
  manÃ¸vreringskrefter for rektangulÃ¦r glideluke brukt som tappe- og/eller stengeorgan.
  Beregningene er utfÃ¸rt i henhold til NVE Retningslinjer 1/2011.
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     1. INNDATA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<h2>1. Inndata og forutsetninger</h2>

<h3>1.1 Lukegeometri</h3>
<table>
  <tr><th>Parameter</th><th>Symbol</th><th>Verdi</th><th>Enhet</th></tr>
  <tr><td>Lukebredde</td>               <td class="formula">B</td>    <td class="val">${s.B}</td>    <td>m</td></tr>
  <tr><td>LukehÃ¸yde</td>                <td class="formula">H_L</td>  <td class="val">${s.H_L}</td>  <td>m</td></tr>
  <tr><td>Underkant luke (over bunn)</td><td class="formula">z_UK</td><td class="val">${s.z_UK}</td> <td>m</td></tr>
  <tr><td>Lukeareal</td>                <td class="formula">A</td>    <td class="val">${r.area.toFixed(3)}</td><td>mÂ²</td></tr>
</table>

<h3>1.2 Vannstander</h3>
<table>
  <tr><th>Parameter</th><th>Symbol</th><th>Verdi</th><th>Enhet</th><th>Merknad</th></tr>
  <tr><td>OppstrÃ¸ms vannstand</td><td class="formula">hâ‚</td><td class="val">${s.h1}</td><td>m</td><td>HRV (hÃ¸yeste regulerte vannstand)</td></tr>
  <tr><td>NedstrÃ¸ms vannstand</td><td class="formula">hâ‚‚</td><td class="val">${s.h2}</td><td>m</td><td>${s.h2 === 0 ? 'TÃ¸rt nedstrÃ¸ms' : 'NedstrÃ¸ms mottrykk'}</td></tr>
  <tr><td>Netto trykkhÃ¸yde</td>  <td class="formula">Î”h</td><td class="val">${(s.h1-s.h2).toFixed(2)}</td><td>m</td><td></td></tr>
</table>

<h3>1.3 Driftsparametere</h3>
<table>
  <tr><th>Parameter</th><th>Valg</th></tr>
  <tr><td>Lukefunksjon</td>       <td>${funksjonLabel}</td></tr>
  <tr><td>Driftstilstand</td>     <td>${driftLabel}</td></tr>
  <tr><td>Konsekvensklasse</td>   <td>Klasse ${s.konsekvensklasse} (jf. damsikkerhetsforskriften Â§ 4-1)</td></tr>
  <tr><td>Grensetilstand</td>     <td>${grensetLabel}</td></tr>
</table>

<h3>1.4 Material- og friksjonsparametere</h3>
<table>
  <tr><th>Parameter</th><th>Symbol</th><th>Verdi</th><th>Enhet</th><th>Referanse</th></tr>
  <tr><td>StÃ¥lkvalitet (flytegrense)</td><td class="formula">R_e</td><td class="val">${s.Re}</td><td>MPa</td><td>NS-EN 10025</td></tr>
  <tr><td>Glidelisttype</td>            <td class="formula">â€“</td>  <td>${glideLabel}</td><td>â€“</td><td>NVE 1/2011 Tabell 5.1</td></tr>
  <tr><td>Friksjonsfaktor (minimum)</td><td class="formula">Î¼</td>  <td class="val">${r.mu}</td><td>â€“</td><td>NVE 1/2011 Â§5.2</td></tr>
  <tr><td>Egenvekt lukekonstruksjon</td><td class="formula">G</td>  <td class="val">${s.G}</td><td>kN</td><td></td></tr>
</table>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     2. BEREGNING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<h2>2. Beregninger</h2>

<h3>2.1 Trykkfordeling</h3>
<p>Vanntrykket beregnes som hydrostatisk trykk (lineÃ¦r trykkfordeling). Netto trykkfordeling er differansen mellom oppstrÃ¸ms og nedstrÃ¸ms trykk.</p>
<table>
  <tr><th>StÃ¸rrelse</th><th>Formel</th><th>Resultat</th><th>Enhet</th><th>Referanse</th></tr>
  <tr><td>Vannvekt Î³_w</td>
      <td class="formula">Î³_w = Ï Â· g</td>
      <td class="val">${r.GAMMA_W.toFixed(2)}</td><td>kN/mÂ³</td><td></td></tr>
  <tr><td>Trykk ved underkant (oppstr.)</td>
      <td class="formula">p_UK,1 = Î³_w Â· hâ‚</td>
      <td class="val">${r.p_UK1.toFixed(3)}</td><td>kN/mÂ²</td><td>NVE Â§2.2</td></tr>
  <tr><td>Trykk ved overkant (oppstr.)</td>
      <td class="formula">p_OK,1 = Î³_w Â· max(hâ‚ â€“ H_L, 0)</td>
      <td class="val">${r.p_OK1.toFixed(3)}</td><td>kN/mÂ²</td><td>NVE Â§2.2</td></tr>
  <tr><td>Trykk ved underkant (nedstr.)</td>
      <td class="formula">p_UK,2 = Î³_w Â· hâ‚‚</td>
      <td class="val">${r.p_UK2.toFixed(3)}</td><td>kN/mÂ²</td><td>NVE Â§2.2</td></tr>
  <tr><td>Trykk ved overkant (nedstr.)</td>
      <td class="formula">p_OK,2 = Î³_w Â· max(hâ‚‚ â€“ H_L, 0)</td>
      <td class="val">${r.p_OK2.toFixed(3)}</td><td>kN/mÂ²</td><td>NVE Â§2.2</td></tr>
  <tr class="highlight"><td>Netto trykk ved underkant</td>
      <td class="formula">p_net,UK = p_UK,1 â€“ p_UK,2</td>
      <td class="val">${r.p_net_UK.toFixed(3)}</td><td>kN/mÂ²</td><td></td></tr>
  <tr class="highlight"><td>Netto trykk ved overkant</td>
      <td class="formula">p_net,OK = p_OK,1 â€“ p_OK,2</td>
      <td class="val">${r.p_net_OK.toFixed(3)}</td><td>kN/mÂ²</td><td></td></tr>
</table>

<h3>2.2 Hydrostatisk resultantkraft og angrepspunkt</h3>
<p>For en trapesfordelt last (lineÃ¦r variasjon fra p_net,UK ved underkant til p_net,OK ved overkant) gjelder:</p>
<table>
  <tr><th>StÃ¸rrelse</th><th>Formel</th><th>Resultat</th><th>Enhet</th><th>Referanse</th></tr>
  <tr class="highlight"><td><strong>Hydrostatisk resultantkraft</strong></td>
      <td class="formula">F_hyd = [(p_net,UK + p_net,OK) / 2] Â· B Â· H_L</td>
      <td class="val">${r.F_hyd.toFixed(3)}</td><td>kN</td><td>Hydrostatikk</td></tr>
  <tr><td>Middeltrykk</td>
      <td class="formula">p_avg = F_hyd / (B Â· H_L)</td>
      <td class="val">${r.p_avg.toFixed(3)}</td><td>kN/mÂ²</td><td></td></tr>
  <tr class="highlight"><td><strong>Angrepspunkt over underkant</strong></td>
      <td class="formula">e = H_L Â· (2Â·p_net,OK + p_net,UK) / [3Â·(p_net,UK + p_net,OK)]</td>
      <td class="val">${r.e_kp.toFixed(4)}</td><td>m</td><td>Trapesformel</td></tr>
  <tr><td>Angrepspunkt (absolutt kote)</td>
      <td class="formula">z_e = z_UK + e</td>
      <td class="val">${r.e_abs.toFixed(4)}</td><td>m</td><td></td></tr>
  <tr><td>Moment om underkant luke</td>
      <td class="formula">M_hyd = F_hyd Â· e</td>
      <td class="val">${r.M_hyd.toFixed(3)}</td><td>kNÂ·m</td><td></td></tr>
</table>

<h3>2.3 Dimensjonerende laster</h3>
<p>
  Lastfaktor fastsettes i henhold til NVE Retningslinjer 1/2011 Tabell 2.1 og Â§ 2.5.
  ${s.funksjon === 'tappe' ? '<strong>Spesialregel Â§2.5:</strong> For tappe- og flomorganer benyttes lastfaktor Î³_f = 1,4 i bruddgrensetilstand.' : ''}
</p>
<table>
  <tr><th>StÃ¸rrelse</th><th>Formel</th><th>Resultat</th><th>Enhet</th><th>Referanse</th></tr>
  <tr><td>Lastfaktor</td>
      <td class="formula">Î³_f = ${r.gamma_f} ${s.funksjon==='tappe'?'(tappeluke, NVE Â§2.5)':'(NVE Tabell 2.1)'}</td>
      <td class="val">${r.gamma_f.toFixed(1)}</td><td>â€“</td><td>NVE 1/2011 Â§2.5, Tab. 2.1</td></tr>
  <tr class="highlight"><td><strong>Dimensjonerende kraft</strong></td>
      <td class="formula">F_dim = Î³_f Â· F_hyd</td>
      <td class="val">${r.F_dim.toFixed(3)}</td><td>kN</td><td>NVE 1/2011 Â§2.5</td></tr>
  <tr><td>Dimensjonerende moment</td>
      <td class="formula">M_dim = Î³_f Â· M_hyd</td>
      <td class="val">${r.M_dim.toFixed(3)}</td><td>kNÂ·m</td><td></td></tr>
</table>

<h3>2.4 ManÃ¸vreringskrefter</h3>
<table>
  <tr><th>StÃ¸rrelse</th><th>Formel</th><th>Resultat</th><th>Enhet</th><th>Referanse</th></tr>
  <tr><td>Friksjonsfaktor (minimum)</td>
      <td class="formula">Î¼ = ${r.mu} (${s.glideliste})</td>
      <td class="val">${r.mu}</td><td>â€“</td><td>NVE 1/2011 Tabell 5.1</td></tr>
  <tr><td>Friksjonskraft</td>
      <td class="formula">F_frict = Î¼ Â· F_hyd</td>
      <td class="val">${r.F_frict.toFixed(3)}</td><td>kN</td><td>NVE 1/2011 Â§5.2</td></tr>
  <tr><td>Egenvekt</td>
      <td class="formula">G</td>
      <td class="val">${s.G.toFixed(1)}</td><td>kN</td><td></td></tr>
  <tr class="highlight"><td><strong>NÃ¸dvendig lÃ¸ftekraft</strong></td>
      <td class="formula">F_lift = G + F_frict</td>
      <td class="val">${r.F_lift.toFixed(3)}</td><td>kN</td><td>NVE 1/2011 Â§5.2</td></tr>
  <tr><td>Paslagsfaktor</td>
      <td class="formula">Ïˆ = ${r.psi} (${funksjonLabel})</td>
      <td class="val">${r.psi}</td><td>â€“</td><td>NVE 1/2011 Â§5.2</td></tr>
  <tr class="highlight"><td><strong>NÃ¸dvendig aktuatorkapasitet</strong></td>
      <td class="formula">F_akt = Ïˆ Â· F_lift</td>
      <td class="val">${r.F_actuator.toFixed(3)}</td><td>kN</td><td>NVE 1/2011 Â§5.2</td></tr>
  <tr><td>Senkekraft (netto)</td>
      <td class="formula">F_lower = G â€“ F_frict</td>
      <td class="val">${r.F_lower.toFixed(3)}</td><td>kN</td><td></td></tr>
  <tr><td>Selvlukkende?</td>
      <td class="formula">F_lower > 0 og > 25% av F_frict</td>
      <td class="val ${r.selfClosing?'':'warn'}">${r.selfClosing ? 'âœ“ Ja' : 'âœ— Nei'}</td><td>â€“</td><td>NVE 1/2011 Â§5.2</td></tr>
  <tr><td>Tettelengde (perimiter)</td>
      <td class="formula">L_t = 2Â·(B + H_L)</td>
      <td class="val">${r.tettelengde.toFixed(2)}</td><td>m</td><td></td></tr>
  <tr><td>Min. tetningskraft (flatgummi)</td>
      <td class="formula">F_seal â‰¥ 5 kN/m Â· L_t</td>
      <td class="val">${r.F_seal_req.toFixed(1)}</td><td>kN</td><td>NVE 1/2011 Â§5.2</td></tr>
</table>

<h3>2.5 Materialkapasitet â€“ stÃ¥l</h3>
<table>
  <tr><th>StÃ¸rrelse</th><th>Formel</th><th>Resultat</th><th>Enhet</th><th>Referanse</th></tr>
  <tr><td>Karakteristisk flytegrense</td>
      <td class="formula">R_e</td>
      <td class="val">${s.Re}</td><td>MPa</td><td></td></tr>
  <tr><td>Materialfaktor (med plastisitetsreserve)</td>
      <td class="formula">Î³_m = ${r.gamma_m}</td>
      <td class="val">${r.gamma_m}</td><td>â€“</td><td>NVE 1/2011 Tabell 4.1</td></tr>
  <tr class="highlight"><td><strong>Dimensjonerende flytegrense</strong></td>
      <td class="formula">f_yd = (R_e Â· 0,8) / Î³_m</td>
      <td class="val">${r.f_yd.toFixed(1)}</td><td>MPa</td><td>NVE 1/2011 Â§4.2</td></tr>
  <tr><td>Korrosjonstillegg</td>
      <td class="formula">t_korr = 1 mm per eksponert flate</td>
      <td class="val">1,0</td><td>mm</td><td>NVE 1/2011 Â§4.2</td></tr>
</table>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     3. FIGUR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page-break"></div>
<h2>3. Skjematisk figur</h2>
<div class="figure-box">
  <img src="${figImg}" alt="Glideluke â€“ hydrostatisk trykkfordeling og krefter" style="max-width:16cm;">
  <figcaption>
    Figur 1: Glideluke med netto hydrostatisk trykkfordeling og krefter.<br>
    F_hyd = ${r.F_hyd.toFixed(2)} kN | Angrepspunkt e = ${r.e_kp.toFixed(3)} m over underkant |
    F_dim = ${r.F_dim.toFixed(2)} kN (Î³_f = ${r.gamma_f}) | F_lift = ${r.F_lift.toFixed(2)} kN
  </figcaption>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     4. KONTROLL OG ADVARSLER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<h2>4. Kontroll og advarsler</h2>

<h3>4.1 Gyldighetssjekker</h3>
<table>
  <tr><th>Kontroll</th><th>Status</th><th>Referanse</th></tr>
  <tr><td>TrykkhÃ¸yde hâ‚ = ${s.h1} m</td>
      <td class="${s.h1>40?'warn':s.h1>20?'warn':'ok'}">${s.h1<=20?'âœ“ â‰¤ 20 m: kavitasjon/vibrasjon normalt uproblematisk':s.h1<=40?'âš  20â€“40 m: lufting nedstrÃ¸ms mÃ¥ vurderes':'âš  > 40 m: spesiell utforming nÃ¸dvendig'}</td>
      <td class="ref">NVE 1/2011 C.4</td></tr>
  <tr><td>Lastfaktor for ${funksjonLabel}</td>
      <td class="ok">âœ“ Î³_f = ${r.gamma_f} anvendt</td>
      <td class="ref">NVE 1/2011 Â§2.5</td></tr>
  <tr><td>Friksjonsfaktor (NVE minimum)</td>
      <td class="ok">âœ“ Î¼ = ${r.mu} (${s.glideliste})</td>
      <td class="ref">NVE 1/2011 Tabell 5.1</td></tr>
  <tr><td>Selvlukkende luke</td>
      <td class="${r.selfClosing?'ok':'warn'}">${r.selfClosing?'âœ“ Ja â€“ netto lukkekraft > 25% av motkrefter':'âš  Nei â€“ ekstern lukkekraft nÃ¸dvendig'}</td>
      <td class="ref">NVE 1/2011 Â§5.2</td></tr>
  <tr><td>Lukebredde vs. -hÃ¸yde (B > H_L)</td>
      <td class="${s.B>s.H_L?'warn':'ok'}">${s.B>s.H_L?'âš  B > H_L: styreruller/styreskinner bÃ¸r vurderes':'âœ“ B â‰¤ H_L: ingen spesielle krav'}</td>
      <td class="ref">NVE 1/2011 C.4</td></tr>
</table>

<h3>4.2 Advarsler og merknader</h3>
<table>
  <tr><th>Merknad</th></tr>
  ${warningRows}
</table>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     5. FORUTSETNINGER OG GYLDIGHETSOMRÃ…DE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<h2>5. Forutsetninger og gyldighetsomrÃ¥de</h2>
<div class="note">
  <strong>GyldighetsomrÃ¥de:</strong> BeregningsverktÃ¸yet dekker hydrostatisk kraftberegning og manÃ¸vreringskrefter
  for rektangulÃ¦re glideluker med uniform bredde i stasjonÃ¦r tilstand. FÃ¸lgende er <em>ikke</em> inkludert og
  mÃ¥ beregnes separat:
  <ul style="margin:6pt 0 0 16pt;">
    <li>Hydrodynamiske trykk og trykkstÃ¸t fra strÃ¸mmende vann</li>
    <li>Vibrasjon og kavitasjon (vurder sÃ¦rskilt for h > 20 m, jf. NVE C.4)</li>
    <li>Luftingsbehov nedstrÃ¸ms tappeluke (alltid vurderes, jf. NVE Â§5.1)</li>
    <li>Strukturdimensjonering av platekasse, bjelker og forbindelser</li>
    <li>Utmattingsanalyse (jf. NVE Vedlegg B for luker med mange belastningsvekslinger)</li>
    <li>Islast, temperaturlast og jordskjelvlast</li>
  </ul>
</div>

<h3>Beregningsstandarder og referanser</h3>
<table>
  <tr><th>Referanse</th><th>Tittel</th></tr>
  <tr><td class="ref">[1] NVE Retningslinjer 1/2011</td><td>Retningslinjer for stenge- og tappeorganer, ror og tverrslagsporter</td></tr>
  <tr><td class="ref">[2] NVE Retningslinjer (2003/2018)</td><td>Retningslinje for laster og dimensjonering</td></tr>
  <tr><td class="ref">[3] Damsikkerhetsforskriften</td><td>Forskrift om sikkerhet ved vassdragsanlegg</td></tr>
  <tr><td class="ref">[4] NS 3472</td><td>Prosjektering av stÃ¥lkonstruksjoner</td></tr>
  <tr><td class="ref">[5] NS-EN 13445</td><td>TrykkpÃ¥kjente konstruksjoner</td></tr>
</table>

<div class="footer-line">
  Rapport generert: ${dato} &nbsp;|&nbsp; BeregningsverktÃ¸y: Glideluke-kalkulator NVE 1/2011 &nbsp;|&nbsp;
  Alle beregninger er brukerens ansvar og bÃ¸r verifiseres av kompetent ingeniÃ¸r.
</div>

</body>
</html>`;
}

function previewReport() {
  if (errors.length > 0) {
    alert('Rett feil i inndata fÃ¸r rapport genereres.');
    return;
  }
  const html = buildReportHTML(false);
  const preview = document.getElementById('reportPreview');
  // Show scaled-down preview in iframe
  preview.innerHTML = '<iframe id="rptFrame" style="width:100%;height:700px;border:none;border-radius:4px;"></iframe>';
  const frame = document.getElementById('rptFrame');
  const doc = frame.contentDocument || frame.contentWindow.document;
  doc.open(); doc.write(html); doc.close();
}

function exportWord() {
  if (errors.length > 0) { alert('Rett feil i inndata fÃ¸r rapport eksporteres.'); return; }
  const html = buildReportHTML(true);
  const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  const prosjekt = document.getElementById('rpt-prosjekt').value.replace(/[^a-zA-Z0-9Ã¦Ã¸Ã¥Ã†Ã˜Ã…\-_]/g,'_') || 'Glideluke';
  const dato = new Date().toISOString().slice(0,10);
  a.href = url; a.download = `Beregningsrapport_${prosjekt}_${dato}.doc`;
  a.click(); URL.revokeObjectURL(url);
}

function exportPDF() {
  if (errors.length > 0) { alert('Rett feil i inndata fÃ¸r rapport eksporteres.'); return; }

  const prosjekt = document.getElementById('rpt-prosjekt').value || 'Glideluke';
  const dato     = new Date().toISOString().slice(0,10);

  // Build report HTML, then inject extra print-optimised CSS before </head>
  let html = buildReportHTML(true);
  const printCSS = `
<style>
  @media print {
    @page { size: A4 portrait; margin: 2cm 2.2cm 2.2cm 2.2cm; }
    body  { font-size: 10.5pt; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    h1    { font-size: 16pt; }
    h2    { font-size: 12pt; page-break-after: avoid; }
    h3    { font-size: 11pt; page-break-after: avoid; }
    table { page-break-inside: avoid; font-size: 9.5pt; }
    tr    { page-break-inside: avoid; }
    .page-break { page-break-before: always; }
    .figure-box img { max-width: 15cm; }
    .footer-line { position: fixed; bottom: 0; width: 100%; font-size: 8pt; }
    /* Force background colours to print */
    th          { background: #1a3a5c !important; color: white !important; }
    .highlight  { background: #dbeafe !important; }
    .warn       { background: #fef3c7 !important; }
    .ok         { background: #dcfce7 !important; }
    tr:nth-child(even) td { background: #f8fafc !important; }
    .note       { background: #f0f4f8 !important; border-left: 3pt solid #2563a8 !important; }
  }
  /* Header/footer via running elements */
  @page {
    @top-center   { content: "${prosjekt} â€“ Beregningsrapport glideluke"; font-size: 8pt; color: #64748b; }
    @bottom-right { content: "Side " counter(page) " av " counter(pages); font-size: 8pt; color: #64748b; }
    @bottom-left  { content: "${dato}"; font-size: 8pt; color: #64748b; }
  }
</style>`;
  html = html.replace('</head>', printCSS + '</head>');

  // Open in new window and trigger print dialog
  const win = window.open('', '_blank', 'width=900,height=700');
  win.document.open();
  win.document.write(html);
  win.document.close();

  // Wait for images to load before printing
  win.onload = () => {
    setTimeout(() => {
      win.focus();
      win.print();
      // Close window after print dialog closes (small delay)
      setTimeout(() => win.close(), 1000);
    }, 600);
  };
}
</script>
</body>
</html>
